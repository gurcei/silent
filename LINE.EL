#OUTPUT "LINE"#DECLARE A$, LOC#DECLARE X=0, Y=0#DECLARE T0=0#DECLARE MODIFIED%=0#DECLARE OLDX, OLDY#DECLARE FNAME$#DECLARE LDATA&(8192), DIDX%=0, PIDX%=0#DECLARE GROUP¯FLAG&, VAL&, REV¯FLAG& = 0GOSUB INIT.MAINGOSUB CHECK¯INPUTGOSUB SHOW¯CURSORGOTO MAIN'----.INIT'----  ' SWITCH BACK TO UPPER-CASE  ' POKE $D018, PEEK($D018) AND $FD  OLDX = -1 : OLDY = -1  DIDX% = 0  GROUP¯FLAG& = 0 : REV¯FLAG& = 0  PRINT "“";  POKE $D020, 0  POKE $D021, 0  RETURN'-----------.CHECK¯INPUT'-----------  GET A$  IF A$<>"" THEN GOSUB DRAW¯INFO  IF A$="" AND X>0 THEN GOSUB RESTORE¯CHAR : X=X-1 : RETURN  IF A$="" AND X<79 THEN GOSUB RESTORE¯CHAR : X=X+1 : RETURN  IF A$="‘" AND Y>0 THEN GOSUB RESTORE¯CHAR : Y=Y-1 : RETURN            IF A$="" AND Y<49 THEN GOSUB RESTORE¯CHAR : Y=Y+1 : RETURN  IF A$="…" THEN GOSUB LOAD¯FILE : RETURN ' F1  IF A$="†" THEN GOSUB SAVE¯FILE : RETURN ' F3  IF A$="ˆ" THEN GOSUB SET¯GROUP¯FLAG : RETURN ' F7  IF A$="‡" THEN GOSUB PLAY¯DATA : RETURN ' F5  IF A$="" THEN REV¯FLAG& = 1 : RETURN  IF A$="’" THEN REV¯FLAG& = 0 : RETURN  IF A$<>"" THEN CURSOR X, Y : GOSUB RESTORE¯CHAR : GOSUB CHK¯REV : PRINT A$; : GOSUB SAVE¯CHAR  RETURN'---------.DRAW¯INFO'---------  PRINT "";CHR$(27);"QFNAME=";FNAME$;"  DIDX%=";DIDX%;  RETURN'-------.CHK¯REV'-------  IF REV¯FLAG& = 1 THEN PRINT "";:ELSE PRINT "’";  RETURN'---------.PLAY¯DATA'---------  PRINT "“";  PIDX% = 0  DO WHILE PIDX% < DIDX%    VAL& = LDATA&(PIDX%) : PIDX% = PIDX% + 1    IF VAL& = $FF THEN GROUP¯FLAG& = 1 : GOTO PD¯ENDLOOP    IF VAL& = $FE THEN GROUP¯FLAG& = 0 : SLEEP .02 : GOTO PD¯ENDLOOP    X = VAL&    IF X >= $80 THEN X=X-$80 : PRINT ""; : ELSE PRINT "’";    Y = LDATA&(PIDX%) : PIDX% = PIDX% + 1    A$ = CHR$(LDATA&(PIDX%)) : PIDX% = PIDX% + 1    CURSOR X, Y: PRINT A$;    IF GROUP¯FLAG& = 0 THEN SLEEP .02.PD¯ENDLOOP  LOOP  RETURN'--------------.SET¯GROUP¯FLAG'--------------  IF GROUP¯FLAG& = 0 THEN BEGIN    GROUP¯FLAG& = 1    LDATA&(DIDX%) = $FF    POKE $D020, $02  BEND:ELSE BEGIN    GROUP¯FLAG& = 0    LDATA&(DIDX%) = $FE    POKE $D020, $00  BEND  DIDX% = DIDX% + 1  RETURN'---------.LOAD¯FILE'---------  INPUT "LOAD NAME: ";FNAME$  IF FNAME$ = "" THEN RETURN  GOSUB INIT  DOPEN #2,(FNAME$),R,U8  DO    GET #2, VAL&    IF ST THEN EXIT    LDATA&(DIDX%) = VAL&    DIDX% = DIDX% + 1  LOOP  DCLOSE #2  GOSUB PLAY¯DATA  RETURN'---------.SAVE¯FILE'---------  INPUT "SAVE NAME: ";FNAME$  IF FNAME$ = "" THEN RETURN  DELETE (FNAME$)  DOPEN #2,(FNAME$),W,U8  FOR X = 0 TO DIDX%    PRINT #2, CHR$(LDATA&(X));  NEXT X    DCLOSE #2  RETURN'---------.SAVE¯CHAR'---------  IF OLDX=X AND OLDY=Y THEN BEGIN    ' REPLACE PREVIOUS CHAR    LDATA&(DIDX%-3) = X + REV¯FLAG& * $80    LDATA&(DIDX%-1) = ASC(A$)  BEND:ELSE:BEGIN    ' WRITE NEW CHAR    LDATA&(DIDX%) = X + REV¯FLAG& * $80 : DIDX% = DIDX% + 1    LDATA&(DIDX%) = Y : DIDX% = DIDX% + 1    LDATA&(DIDX%) = ASC(A$) : DIDX% = DIDX% + 1        OLDX=X : OLDY=Y  BEND  RETURN  '------------  .RESTORE¯CHAR'------------  IF MODIFIED% THEN BEGIN    LOC = $FF80000 + X + 80 * Y    POKE LOC, PEEK(LOC) XOR 32    MODIFIED% = 0    T0 = TI  BEND  RETURN'-----------.SHOW¯CURSOR'-----------  IF TI > T0 THEN T0 = TI + .5:ELSE RETURN  LOC = $FF80000 + X + 80 * Y  POKE LOC, PEEK(LOC) XOR 32  MODIFIED% = MODIFIED% XOR 1  RETURN