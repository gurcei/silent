#OUTPUT "SILENT"' ¬¡ŒÀ4 ÕEMORY USAGE' ------------------' 4.0000 ƒÕ¡-Ã…”‘' 4.0020 VAR INTERFACE TO ASSEMBLY'        0020: PTR TO DEFAULTØRED&'        0022: PTR TO DEFAULTØGREEN&'        0024: PTR TO DEFAULTØBLUE&'        0026: PTR TO CURRØRED&'        0028: PTR TO CURRØGREEN&'        002A: PTR TO CURRØBLUE&'        002C: PTR TO DATAØADDR%'        002E: PTR TO CDATAØADDR%'        0030: PTR TO SCRADDR%'        0032: PTR TO CLRADDR%'        0034: PTR TO INC%'        0036: PTR TO STARX%'        0038: PTR TO STARVX%' 4.0800 ”√“≈≈Œ Õ≈Õœ“Ÿ' 4.2000 –≈‘”√…… «“¡–»…√” FOR ¬¡” LOGO' ¬¡ŒÀ5 ÕEMORY USAGE' ------------------' 5.0000 SCREEN BUFFER FOR DRAWØPETSCIIØFRAME' 5.1000 COLOR RAM BUFFER FOR DRAWØPETSCIIØFRAME' 5.2000 SCREEN BUFFER2 FOR 'ANATHEMA' LAYER' 5.4000 COLOR RAM BUFFER2 FOR 'ANATHEMA' LAYER' 5.3000 SCREEN BUFFER3 FOR 'THE SILENT ENIGMA' LAYER' 5.4000 COLOR RAM BUFFER3 FOR 'THE SILENT ENIGMA' LAYER'--------.DECLARES'--------#DECLARE STARX%(20), STARY(20), STARVX%(20)#DECLARE K#DECLARE FNAME$, VAL&#DECLARE LDATA&(2, 12288), DIDX%(2)=0, PIDX%(2)=0, FIDX%=0#DECLARE GROUPØFLAG&, VAL&, REVØFLAG&(2) = 0#DECLARE OFFS(2), VER(2)#DECLARE LASTFLAG, LASTØGROUPØIDX#DECLARE OLDX, OLDY, OLDOFFS(2), X, Y, A$, XX, YY, DXX, DYY, DEBUG, Z$#DECLARE WXX, WYY#DECLARE CHR, TMP#DECLARE SRCØADDR, DESTØADDR, LENGTH, TRANSP#DECLARE LOC, PTR, M, TSTART, ADDR#DECLARE CHARØCNT, CHARØIDX%(60), CHARØWIDTH%(60), MAXØWIDTH#DECLARE TXTØK, S$, RET#DECLARE MNØSTATE = 0, WCØFLAG, WCØCHR#DECLARE QLIDX, QLCNT#DECLARE QLX1(10), QLY1(10), QLX2(10), QLY2(10), QLX3(10), QLY3(10)#DECLARE QLX4(10), QLY4(10)#DECLARE QLVX1, QLVY1, QLVX2, QLVY2#DECLARE QLCLR(10), QLCURCLR, KK, T, T1, T2, TX, TY, SIDES, SQINC#DECLARE X1, Y1, X2, Y2, SQANG#DECLARE DIFFX, DIFFY, DELTAX, DELTAY, TANVAL, ANGLE#DECLARE CENTREX, CENTREY, CENTREZ#DECLARE CBØANGA, CBØANGB, CBIDX, CBTMP, PZ#DECLARE CBØINCA, CBØINCB, RETØANG, ZFACT#DECLARE PX(10), PY(10), PLEN, PANG, PIDX, PDIST#DECLARE –… = 3.141592654269.¬¡”Ãœ«œ.≈ÃØDEFINES'==================  ' PALETTE  ' -------  #DECLARE DEFAULTØRED&(32), BKPØRED&(32)  #DECLARE DEFAULTØGREEN&(32), BKPØGREEN&(32)  #DECLARE DEFAULTØBLUE&(32), BKPØBLUE&(32)  #DECLARE CURRØRED&(32)  #DECLARE CURRØGREEN&(32)  #DECLARE CURRØBLUE&(32)  #DECLARE FADEVAL, TEMPVAL#DECLARE LOGOØSTATE, FRAMEIDX, FX, FY, MIRROR, BASØSTATE#DECLARE FRMY(3), ORIGØFRMY(3), FINISHØCNT, BCNT#DECLARE INC(3), INCØDIR(3), DATAØADDR%, CDATAØADDR%#DECLARE SCRADDR%, CLRADDR%, INC%, MAXØFRAMES, FRMØIDX#DECLARE FRAMEØADDR%(25), FRMX, FRMY, FRMW, FRMH, FRMX1, FRMY1#DECLARE SZ, FLIPØVAR, UPPERØNIBBLE, LOWERØNIBBLE#DECLARE RAINØIDX, PLEN, RAINBOWSTR$, RAINBOWØX, RAINBOWØY#DECLARE SUBTEXT$(2), SUBTEXTØIDX = 0SUBTEXT$(0) = "PRESENTS..."SUBTEXT$(1) = "A SONG BY...".MUSICØVARS'----------#DEFINE CHUNKØMAX = 50#DECLARE CHUNKØCNT, CHUNKØIDX, VIDX, TMPO%, ROW#DECLARE ECHOØM, ECHOØB, ECHOØSZ = .05, CHUNKØRPT, ECHOØDELAY#DECLARE V$(5,CHUNKØMAX), V#DECLARE SONG$#DECLARE V1$, V2$, V3$, V4$, V5$, V6$#DECLARE CURRØFREQ, CURRØDIR#DECLARE SEQCNT#DECLARE SEQØCHUNK(200), SEQØEXTRA(200)#DECLARE PLYPTR, PLYFLAG, RET%, TMP$#DEFINE √ÕƒØ‘≈Õ–œ = -1#DEFINE √ÕƒØ∆…Ã‘≈“ = -2#DEFINE √ÕƒØÃœœ– = -3#DEFINE √ÕƒØ≈√»œØÕ1 = -4   ' ECHO MELODY: VOICE 1 ON VOICE 4#DEFINE √ÕƒØ≈√»œØÕ2 = -5   ' ECHO MELODY: VOICE 1 ON VOICE 2 + 4 + 5#DEFINE √ÕƒØ≈√»œØ¬  = -6   ' ECHO BASS:   VOICE 3 ON VOICE 6#DEFINE √ÕƒØ≈√»œØœ∆∆ = -7#DEFINE √ÕƒØ≈√»œØ”⁄ = -8#DEFINE √ÕƒØ÷œÃ = -9#DEFINE √ÕƒØƒ≈Ã¡Ÿ = -10#DEFINE √ÕƒØÕ¡ÿ = 11#DEFINE ∆“ÕØ¬ = 0#DEFINE ∆“ÕØ¡ = 1#DEFINE ∆“ÕØ” = 2#DEFINE ∆“ÕØ¬¡√Àƒ“œ– = 3.OFFSETS#DEFINE œ∆∆”≈‘Øƒ¡‘¡Ø”…⁄≈  = 0#DEFINE œ∆∆”≈‘ØŒ’ÕØ∆“¡Õ≈” = 2#DEFINE œ∆∆”≈‘Ø∆“¡Õ≈0     = 3#DEFINE ∆“ÕØœ∆∆”≈‘Øÿ          = 0#DEFINE ∆“ÕØœ∆∆”≈‘ØŸ          = 1#DEFINE ∆“ÕØœ∆∆”≈‘Ø◊          = 2#DEFINE ∆“ÕØœ∆∆”≈‘Ø»          = 3#DEFINE ∆“ÕØœ∆∆”≈‘Ø»…‘¬œÿ≈”   = 4#DEFINE ∆“ÕØœ∆∆”≈‘Ø»¬Ø»≈¡ƒ    = 4#DEFINE ∆“ÕØœ∆∆”≈‘Ø»¬Ø‘œ“”œ   = 8#DEFINE ∆“ÕØœ∆∆”≈‘Ø»¬Ø∆≈≈‘    = 12#DEFINE ∆“ÕØœ∆∆”≈‘Ø»¬Ø¡‘‘¡√À  = 16#DEFINE ∆“ÕØœ∆∆”≈‘Øƒ¡‘¡       = 20'-------.DEFINES'-------#DEFINE œ–Ø√œ–Ÿ = 0#DEFINE œ–ØÕ…ÿ  = 1#DEFINE œ–Ø”◊¡– = 2#DEFINE œ–Ø∆…ÃÃ = 3#DEFINE ƒ”‘Øƒ≈√ = 32#DEFINE ”“√Øƒ≈√ = 16#DEFINE ”‘Ø∆¡ƒ≈Ø‘œØ◊»…‘≈ = 0#DEFINE ”‘Øƒ“¡◊Ø¬¡√Àƒ“œ–ØœŒÃŸ = 1#DEFINE ”‘Ø∆¡ƒ≈Ø‘œØƒ≈∆¡’Ã‘ = 2#DEFINE ”‘Øƒ“œ–Ø…ŒØ¬ = 3#DEFINE ”‘Ø–“≈”≈Œ‘” = 4#DEFINE ”‘Ø∆¡ƒ≈Ø‘œØ”‘¡“” = 5#DEFINE ”‘Øƒ“¡◊Ø¡Œ¡‘»≈Õ¡ = 6#DEFINE ”‘Øƒ“¡◊Ø”œŒ«Ø‘…‘Ã≈ = 7#DEFINE ”‘Ø”»œ◊Ø—…ÿØÃ…Œ≈” = 8#DEFINE ”‘Ø”»œ◊ØÃŸ“…√” =9'----.MAIN'----  GOSUB INIT  GOSUB STATEØLOOP  END'-------------.ITERØMAINDEMO'-------------  IF MNØSTATE = 0 THEN BEGIN    S$ = "…N DREAMLAND..."    TXTØK = 1    MNØSTATE = 1  BEND  IF MNØSTATE = 1 THEN BEGIN    FIDX% = 2    GOSUB ITERØWRITEØTEXT  BEND  IF PLYPTR = -1 AND RPLAY(1)=0 THEN PRINT "ìTHE END!":END  RETURN'----------.STATEØLOOP'----------  TSTART = TI  IF LOGOØSTATE = ”‘Ø∆¡ƒ≈Ø‘œØ◊»…‘≈ THEN BEGIN    GOSUB FADEØTOØWHITE    LOGOØSTATE = ”‘Øƒ“¡◊Ø¬¡√Àƒ“œ–ØœŒÃŸ  BEND    IF LOGOØSTATE = ”‘Øƒ“¡◊Ø¬¡√Àƒ“œ–ØœŒÃŸ THEN BEGIN    BANK 128    POKE $D020, 1, 1    GOSUB INITØ80X50    GOSUB DRAWØBACKDROP    GOSUB PAGEØFLIP    GOSUB STOREØCURRØCOLOURS    GOSUB SETØPALETTEØFORØBACKDROP    FADEVAL=0    M=0    LOGOØSTATE = ”‘Ø∆¡ƒ≈Ø‘œØƒ≈∆¡’Ã‘  BEND    IF LOGOØSTATE = ”‘Ø∆¡ƒ≈Ø‘œØƒ≈∆¡’Ã‘ THEN BEGIN    IF FADEVAL <= 128 THEN BEGIN      ' FADEØCOLOURSØTOØDEFAULTS      BANK 0:VSYNC 10:SYS $7E03, FADEVAL:BANK 128      FADEVAL = FADEVAL + 1    BEND    ' CYCLEØALTØPALETTE    BANK 0:SYS $7E06:BANK 128    M = M + 1    IF M = 130 THEN LOGOØSTATE = ”‘Øƒ“œ–Ø…ŒØ¬  BEND  IF LOGOØSTATE = ”‘Øƒ“œ–Ø…ŒØ¬ THEN BEGIN    GOSUB ANIMATEØLOGO    ' CYCLEØALTØPALETTE    BANK 0:SYS $7E06:BANK 128    M = M + 1    IF M > 250 THEN LOGOØSTATE = ”‘Ø–“≈”≈Œ‘”:FADEVAL = 0  BEND  IF LOGOØSTATE = ”‘Ø–“≈”≈Œ‘” THEN BEGIN    GOSUB ANIMØDRAWØSUBTEXT    ' CYCLEØALTØPALETTE    BANK 0:SYS $7E06:BANK 128    M = M + 1    IF M > 360 THEN BEGIN      ' FADE TO BLACK      BANK 0:SYS $7E0C, FADEVAL:BANK 128      FADEVAL = FADEVAL + 1    BEND    IF FADEVAL = 128 THEN BEGIN      POKE $D020, 0, 0      PRINT "ì";      GOSUB STOREØCURRØCOLOURS      GOSUB RESTOREØDEFAULTØPALETTE      LOGOØSTATE = ”‘Ø∆¡ƒ≈Ø‘œØ”‘¡“”      FADEVAL = 0    BEND  BEND  IF LOGOØSTATE = ”‘Ø∆¡ƒ≈Ø‘œØ”‘¡“” THEN BEGIN      IF FADEVAL <= 128 THEN BEGIN        ' FADEØCOLOURSØTOØDEFAULTS        BANK 0:VSYNC 10:SYS $7E03, FADEVAL:BANK 128        FADEVAL = FADEVAL + 1      BEND      GOSUB DRAWØSTARFIELD      GOSUB PAGEØFLIP      GOSUB ITERØSTARFIELD      IF FADEVAL = 129 THEN LOGOØSTATE = ”‘Øƒ“¡◊Ø¡Œ¡‘»≈Õ¡ : M = 0  BEND  IF LOGOØSTATE = ”‘Øƒ“¡◊Ø¡Œ¡‘»≈Õ¡ THEN BEGIN    ' GOSUB ITERØMAINDEMO    M = M + 1    GOSUB DRAWØSTARFIELD    ' DRAW ANATHEMA LOGO    FIDX%=0    GOSUB PLAYØDATAØITER  ' LINE DATA    GOSUB PAGEØFLIP    GOSUB ITERØSTARFIELD    IF M = 720 THEN BEGIN      LOGOØSTATE = ”‘Øƒ“¡◊Ø”œŒ«Ø‘…‘Ã≈      M = 0      OFFS(1) = -25    BEND  BEND  IF LOGOØSTATE = ”‘Øƒ“¡◊Ø”œŒ«Ø‘…‘Ã≈ THEN BEGIN    M = M + 1    GOSUB DRAWØSTARFIELD    ' SCROLL OFF ANATHEMA    IF M > 150 AND M < 230 THEN FIDX%=0:GOSUB SCROLLØCANVASØRIGHT    ' DRAW SONG TITLE    IF M > 10 AND M < 1900 THEN BEGIN      FIDX%=1      GOSUB PLAYØDATAØITER      GOSUB PLAYØDATAØITER      IF MOD(M, 4) = 0 THEN GOSUB SCROLLØCANVASØRIGHT      ' IF M > 1910 THEN GOSUB SCROLLØCANVASØRIGHT    BEND    IF PLYPTR >= 9 THEN GOSUB DRAWØQIXØLINES    GOSUB PAGEØFLIP    GOSUB ITERØSTARFIELD  BEND  DO    RET% = 0    DO WHILE RET% = 0      GOSUB PARSEØCURRENTØSEQPTR    LOOP  LOOP WHILE (TI-TSTART) < .03  GOTO STATEØLOOP  RETURN'----------.INITØ80X50'----------  ' SWITCH BACK TO UPPER-CASE  POKE $D018, PEEK($D018) AND $FD  ' SWITCH TO 80X50  ' SETBIT »œ‘“≈«Ø7, 7  ' POKE $D031, $E8 ' 1110 1000 = »640,∆¡”‘,¡‘‘“,÷400  PRINT CHR$(27);"5";  ' WPOKE ”√“Œ–‘“Ã”¬, $0800  ' POKE ”√“Œ–‘“¬ŒÀ, $04  RETURN'-------------.DRAWØBACKDROP'-------------    FRAMEIDX = ∆“ÕØ¬¡√Àƒ“œ–    FX=-999 : FY = -999    MIRROR = 0    GOSUB DRAWØPETSCIIØFRAME    RETURN'------------.ANIMATEØLOGO'------------  IF BASØSTATE = 0 THEN BEGIN    ORIGØFRMY(0) = 6    ORIGØFRMY(1) = 23    ORIGØFRMY(2) = 6    FRMY(0) = -44    FRMY(1) = -69    FRMY(2) = -107    BASØSTATE = 1    INCØDIR(0) = 1    INC(0) = 1    INCØDIR(1) = 1    INC(1) = 1    INCØDIR(2) = 1    INC(2) = 1    INCØDIR(3) = 1    INC(3) = 1  BEND  IF BASØSTATE = 1 THEN BEGIN    FINISHØCNT = 0    FOR K = 0 TO 2      IF FRMY(K) < ORIGØFRMY(K) THEN BEGIN        FRMY(K) = FRMY(K) + 2        IF FRMY(K) > ORIGØFRMY(K) THEN FRMY(K) = ORIGØFRMY(K)      BEND      IF FRMY(K) = ORIGØFRMY(K) THEN FINISHØCNT = FINISHØCNT OR 2^K    NEXT K  BEND  GOSUB DRAWØBAS  GOSUB PAGEØFLIP  FOR FRAMEIDX = 0 TO 2    IF FINISHØCNT AND 2^FRAMEIDX AND BCNT(FRAMEIDX)<3 THEN BEGIN      INC(FRAMEIDX) = INC(FRAMEIDX) + .2 * INCØDIR(FRAMEIDX)      IF INC(FRAMEIDX) < .6 THEN BEGIN        INCØDIR(FRAMEIDX) = 1        BCNT(FRAMEIDX)=BCNT(FRAMEIDX)+1      BEND      IF INC(FRAMEIDX) > 2.9 THEN BEGIN        INCØDIR(FRAMEIDX) = -1        BCNT(FRAMEIDX)=BCNT(FRAMEIDX)+1      BEND      IF BCNT(FRAMEIDX) = 2 AND INC(FRAMEIDX) > 1 THEN BEGIN        INC(FRAMEIDX) = 1        BCNT(FRAMEIDX)=BCNT(FRAMEIDX)+1      BEND    BEND    BEND  NEXT FRAMEIDX    RETURN'------------.INITØBASLOGO'------------  BANK 0:BLOAD "ASMHELPER":BANK 128  LOGOØSTATE = 0  GOSUB STOREØDEFAULTØCOLOURS  INCØDIR(3) = -1  INC(3) = 1  ' CLEAR DMA LIST AREA  FOR K = 0 TO 20    POKE $40000+K, 0  NEXT K  POKE $40000, $81 ' OPT = DEST ADDR Õ¬ SELECTOR  POKE $40001, $00 ' DEFAULT TO 1ST MEGABYTE  POKE $40002, $07 ' OPT = ENABLE TRANSPARENCY  POKE $40003, $86 ' OPT = SET TRANSPARENCY  POKE $40004, $20 ' TRANSPARENCY VALUE  POKE $40005, $00 ' END OF OPTIONS  POKE $40006, $00 ' √Õƒ LSB = √œ–Ÿ  WPOKE $40007, $0000 ' LENGTH  WPOKE $40009, $1000 ' SOURCE ADDR  POKE $4000B, $05    ' SOURCE BANK  WPOKE $4000C, $1000 ' DEST ADDR  POKE $4000E, $05    ' DEST BANK  POKE $4000F, $00    ' √Õƒ MSB (IGNORE)  WPOKE $40010, $0000 ' MODULO (IGNORE)  ' INIT VAR INTERFACE TO ASSEMBLY  LOC = $40020  PTR = POINTER(DEFAULTØRED&(0))  GOSUB STOREØPTR  PTR = POINTER(DEFAULTØGREEN&(0))  GOSUB STOREØPTR  PTR = POINTER(DEFAULTØBLUE&(0))  GOSUB STOREØPTR  PTR = POINTER(CURRØRED&(0))  GOSUB STOREØPTR  PTR = POINTER(CURRØGREEN&(0))  GOSUB STOREØPTR  PTR = POINTER(CURRØBLUE&(0))  GOSUB STOREØPTR  PTR = POINTER(DATAØADDR%)  GOSUB STOREØPTR  PTR = POINTER(CDATAØADDR%)  GOSUB STOREØPTR  PTR = POINTER(SCRADDR%)  GOSUB STOREØPTR  PTR = POINTER(CLRADDR%)  GOSUB STOREØPTR  PTR = POINTER(INC%)  GOSUB STOREØPTR  RETURN'---------.LOADØDATA'---------  PTR = $42000    BLOAD "BAS.BIN",P(PTR)  GOSUB INITØPETSCIIØFRAMES  GOSUB ØINCREMENTØPTRØTOØNEXTØFREE  RETURN'-------------------.INITØPETSCIIØFRAMES'-------------------  TMP = PTR  MAXØFRAMES = PEEK(PTR + œ∆∆”≈‘ØŒ’ÕØ∆“¡Õ≈”)  'PRINT  'PRINT "PTR=";HEX$(PTR + œ∆∆”≈‘ØŒ’ÕØ∆“¡Õ≈”)  PTR = PTR + œ∆∆”≈‘Ø∆“¡Õ≈0  'PRINT  'PRINT "- MXØFRM=";MAXØFRAMES;": "  FRMØIDX = 0  DO WHILE FRMØIDX < MAXØFRAMES    'PRINT FRMØIDX;    FRAMEØADDR%(FRMØIDX) = MOD(PTR,65536)    FRMX = PEEK(PTR + ∆“ÕØœ∆∆”≈‘Øÿ)    FRMY = PEEK(PTR + ∆“ÕØœ∆∆”≈‘ØŸ)    FRMW = PEEK(PTR + ∆“ÕØœ∆∆”≈‘Ø◊)    FRMH = PEEK(PTR + ∆“ÕØœ∆∆”≈‘Ø»)    FRMX1=FRMX+FRMW-1    FRMY1=FRMY+FRMH-1    DATAØADDR% = MOD(PTR, 65536)    DATAØADDR% = DATAØADDR% + ∆“ÕØœ∆∆”≈‘Øƒ¡‘¡    CDATAØADDR% = DATAØADDR% + FRMW * FRMH    BANK 4    FOR Y = 0 TO FRMY1-FRMY      FOR X = 0 TO FRMX1-FRMX        IF PEEK(DATAØADDR% + X + Y * FRMW) = 102 THEN BEGIN          POKE (CDATAØADDR% + X + Y * FRMW), $FF        BEND      NEXT X    NEXT Y    BANK 128        'PRINT "PTR=";HEX$(PTR);", IDX=";FRMØIDX;", W=";FRMW;", H=";FRMH    PTR = PTR + ∆“ÕØœ∆∆”≈‘Øƒ¡‘¡ + FRMW * FRMH * 2    'PRINT "FRMØIDX=";FRMØIDX    FRMØIDX = FRMØIDX + 1  LOOP  PTR = TMP  RETURN'---------------------------.ØINCREMENTØPTRØTOØNEXTØFREE'---------------------------  PTR = TMP  SZ = WPEEK(PTR + œ∆∆”≈‘Øƒ¡‘¡Ø”…⁄≈)  'PRINT  'PRINT "INC SZ = ";SZ  'PRINT "PTR = ";HEX$(PTR + œ∆∆”≈‘Øƒ¡‘¡Ø”…⁄≈)  PTR = PTR + SZ  'GET KEY A$  RETURN'--------.DRAWØBAS'--------  FRAMEIDX = ∆“ÕØ¬¡√Àƒ“œ–  FX=-999 : FY = -999  MIRROR = 0  GOSUB DRAWØPETSCIIØFRAME  FRAMEIDX = ∆“ÕØ¬  FX=-999 : FY=FRMY(0)  MIRROR = 0  GOSUB DRAWØPETSCIIØFRAME  FRAMEIDX = ∆“ÕØ¡  FX=-999 : FY=FRMY(1)  MIRROR = 0  GOSUB DRAWØPETSCIIØFRAME  FRAMEIDX = ∆“ÕØ”  FX=-999 : FY=FRMY(2)  MIRROR = 0  GOSUB DRAWØPETSCIIØFRAME  RETURN'------------------.DRAWØPETSCIIØFRAME'------------------  POKE $4000B, $04  ' ASSURE SOURCE BANK 4 (FOR ORIGINAL FRAME DATA)  IF MIRROR = 1 THEN SETBIT $40006, 5:ELSE CLRBIT $40006, 5  DATAØADDR% = FRAMEØADDR%(FRAMEIDX)  BANK 4  FRMX = PEEK(DATAØADDR% + ∆“ÕØœ∆∆”≈‘Øÿ)  FRMY = PEEK(DATAØADDR% + ∆“ÕØœ∆∆”≈‘ØŸ)  FRMW = PEEK(DATAØADDR% + ∆“ÕØœ∆∆”≈‘Ø◊)  FRMH = PEEK(DATAØADDR% + ∆“ÕØœ∆∆”≈‘Ø»)  BANK 128  IF FX<>-999 THEN FRMX = FX ' OVERRIDE POSITION  IF FY<>-999 THEN FRMY = FY  FRMX1=FRMX+FRMW-1  FRMY1=FRMY+FRMH-1  SCRADDR% = $0000 + FRMX + (FRMY+FRMH-1) * 80  CLRADDR% = $1000 + FRMX + (FRMY+FRMH-1) * 80  IF MIRROR = 1 THEN CLRADDR% = CLRADDR% + FRMW - 1  DATAØADDR% = DATAØADDR% + ∆“ÕØœ∆∆”≈‘Øƒ¡‘¡  CDATAØADDR% = DATAØADDR% + FRMW * FRMH  INC% = INC(FRAMEIDX) * 256  ' ASM: DRAWØPETSCIIØFRAME  BANK 0:SYS $7E09, MOD(FRMY+256,256), MOD(FRMY1+256,256), FRMW  RETURN.FADEØTOØWHITE'-------------  FOR FADEVAL=0 TO 128    ' FADEØCOLOURSØTOØWHITE    BANK 0:VSYNC 10:SYS $7E00, FADEVAL:BANK 128    DO WHILE RET% = 0      GOSUB PARSEØCURRENTØSEQPTR    LOOP  NEXT FADEVAL  RETURN.STOREØDEFAULTØCOLOURS'---------------------  FOR K = 0 TO 31    DEFAULTØRED&(K)=PEEK($D100+K)    DEFAULTØGREEN&(K)=PEEK($D200+K)    DEFAULTØBLUE&(K)=PEEK($D300+K)  NEXT K  RETURN.STOREØCURRØCOLOURS'------------------  FOR K = 0 TO 31    CURRØRED&(K)=PEEK($D100+K)    CURRØGREEN&(K)=PEEK($D200+K)    CURRØBLUE&(K)=PEEK($D300+K)  NEXT K  RETURN'------------------------.SETØPALETTEØFORØBACKDROP'------------------------#DEFINE √œÃ1Ø“ = $DA ' 218#DEFINE √œÃ1Ø« = $89 ' 137#DEFINE √œÃ1Ø¬ = $00 ' 0#DEFINE √œÃ2Ø“ = $1B ' 27#DEFINE √œÃ2Ø« = $42 ' 66#DEFINE √œÃ2Ø¬ = $0B ' 11  ' PRESERVE ORIGINAL PALETTE SOMEWHERE  FOR K = 0 TO 31    BKPØRED&(K) = DEFAULTØRED&(K)    BKPØGREEN&(K) = DEFAULTØGREEN&(K)    BKPØBLUE&(K) = DEFAULTØBLUE&(K)  NEXT K  FOR K = 12 TO 21    FLIPØVAR = √œÃ1Ø“ + (√œÃ2Ø“-√œÃ1Ø“) * (K-12)/9    GOSUB FLIPØNIBBLE    DEFAULTØRED&(K) = FLIPØVAR    DEFAULTØRED&(43-K) = FLIPØVAR    FLIPØVAR = √œÃ1Ø« + (√œÃ2Ø«-√œÃ1Ø«) * (K-12)/9    GOSUB FLIPØNIBBLE    DEFAULTØGREEN&(K) = FLIPØVAR    DEFAULTØGREEN&(43-K) = FLIPØVAR    FLIPØVAR = √œÃ1Ø¬ + (√œÃ2Ø¬-√œÃ1Ø¬) * (K-12)/9    GOSUB FLIPØNIBBLE    DEFAULTØBLUE&(K) = FLIPØVAR    DEFAULTØBLUE&(43-K) = FLIPØVAR  NEXT K  RETURN'-----------------------.RESTOREØDEFAULTØPALETTE'-----------------------  FOR K = 0 TO 31    DEFAULTØRED&(K) = BKPØRED&(K)    DEFAULTØGREEN&(K) = BKPØGREEN&(K)    DEFAULTØBLUE&(K) = BKPØBLUE&(K)  NEXT K  RETURN'-----------.FLIPØNIBBLE'-----------  LOWERØNIBBLE = FLIPØVAR AND $0F  UPPERØNIBBLE = (FLIPØVAR >> 4) AND $0F  FLIPØVAR = (LOWERØNIBBLE << 4) + UPPERØNIBBLE  RETURN.ANIMØDRAWØSUBTEXT'-----------------  IF M = 330 THEN BEGIN    SUBTEXTØIDX = 1    PLEN = 0    EDMA 3,80,32,$40800+80*46  BEND  IF PLEN < LEN(SUBTEXT$(SUBTEXTØIDX)) THEN BEGIN    PLEN = PLEN + .25    RAINBOWSTR$=LEFT$(SUBTEXT$(SUBTEXTØIDX),PLEN)    IF SUBTEXTØIDX = 0 THEN RAINBOWØX = 35:ELSE RAINBOWØX = 33    RAINBOWØY = 46    GOSUB PRINTØRAINBOWØSTR  BEND  RETURN.PRINTØRAINBOWØSTR'-----------------  CURSOR RAINBOWØX, RAINBOWØY  FOR RAINØIDX=1 TO LEN(RAINBOWSTR$)    FOREGROUND MOD(RAINØIDX-1,16)+16    PRINT MID$(RAINBOWSTR$,RAINØIDX,1);  NEXT RAINØIDX  RETURN'--------------.DRAWØQIXØLINES'--------------  FOR K = 0 TO QLCNT - 1    KK = MOD(QLIDX + K, 10)    SYS $7E24, QLCLR(KK) + 64    X1 = QLX1(KK)    Y1 = QLY1(KK)    X2 = QLX2(KK)    Y2 = QLY2(KK)    SYS $7E21, X1, Y1, X2, Y2    ' GOSUB DRAWØLINE  NEXT K  ' CALC NEXT LINE POSITIONS  KK = QLIDX  ' OLD QLIDX  QLIDX = MOD(QLIDX + 1, 10)  IF QLCNT < 10 THEN QLCNT = QLCNT + 1  QLX1(QLIDX) = QLX1(KK) + QLVX1  IF QLX1(QLIDX) >= 160 AND QLVX1 > 0 THEN QLX1(QLIDX)=159 : QLVX1 = -QLVX1  IF QLX1(QLIDX) < 0 AND QLVX1 < 0 THEN QLX1(QLIDX)=0 : QLVX1 = -QLVX1  QLY1(QLIDX) = QLY1(KK) + QLVY1  IF QLY1(QLIDX) >= 100 AND QLVY1 > 0 THEN QLY1(QLIDX)=99 : QLVY1 = -QLVY1  IF QLY1(QLIDX) < 0 AND QLVY1 < 0 THEN QLY1(QLIDX)=0 : QLVY1 = -QLVY1  QLX2(QLIDX) = QLX2(KK) + QLVX2  IF QLX2(QLIDX) >= 160 AND QLVX2 > 0 THEN QLX2(QLIDX)=159 : QLVX2 = -QLVX2  IF QLX2(QLIDX) < 0 AND QLVX2 < 0 THEN QLX2(QLIDX)=0 : QLVX2 = -QLVX2  QLY2(QLIDX) = QLY2(KK) + QLVY2  IF QLY2(QLIDX) >= 100 AND QLVY2 > 0 THEN QLY2(QLIDX)=99 : QLVY2 = -QLVY2  IF QLY2(QLIDX) < 0 AND QLVY2 < 0 THEN QLY2(QLIDX)=0 : QLVY2 = -QLVY2  QLCURCLR = MOD(QLCURCLR + 1, 16)  QLCLR(QLIDX) = QLCURCLR  RETURN'------------------.DRAWØQIXØTRIANGLES'------------------  SIDES = 3  SQANG = - –… / 2  GOSUB DRAWØQIXØPOLY  RETURN'----------------.DRAWØQIXØSQUARES'----------------  SIDES = 4  SQANG = - 3 * –… / 4  GOSUB DRAWØQIXØPOLY  RETURN'-------------.DRAWØQIXØPOLY'-------------  ' INIT  QLIDX = 0  SQINC = 2 * –… / SIDES  QLCNT = 1  T = 0  PDIST = 45.TRIØLOOP  PDIST = 22.5 - 22.5 * COS(T)  CENTREX = 80 : CENTREY = 50  PANG = SQANG  QLX1(QLIDX) = CENTREX + PDIST * COS(PANG)  QLY1(QLIDX) = CENTREY + PDIST * SIN(PANG)  PANG = PANG + SQINC  QLX2(QLIDX) = CENTREX + PDIST * COS(PANG)  QLY2(QLIDX) = CENTREY + PDIST * SIN(PANG)  PANG = PANG + SQINC  QLX3(QLIDX) = CENTREX + PDIST * COS(PANG)  QLY3(QLIDX) = CENTREY + PDIST * SIN(PANG)  IF SIDES = 4 THEN BEGIN    PANG = PANG + SQINC    QLX4(QLIDX) = CENTREX + PDIST * COS(PANG)    QLY4(QLIDX) = CENTREY + PDIST * SIN(PANG)  BEND    QLCURCLR = MOD(QLCURCLR + 1, 16)  QLCLR(QLIDX) = QLCURCLR  VSYNC 0  PRINT "ì";  FOR K = 0 TO QLCNT - 1    ' KK = MOD(QLIDX + QLCNT-1 - K, 5)    KK = MOD(QLIDX + K, 5)    SYS $7E0C, QLCLR(KK) + 64    X1 = QLX1(KK)    Y1 = QLY1(KK)    X2 = QLX2(KK)    Y2 = QLY2(KK)    'CURSOR 0,0:PRINT CHR$(27);"QX1,Y1,X2,Y2=",INT(X1),INT(Y1),INT(X2),INT(Y2)    'CURSOR 0,1:PRINT CHR$(27);"QVX1,VY1,VX2,VY2=";QLVX1;QLVY1;QLVX2;QLVY2    GOSUB DRAWØLINE    TX = X1    TY = Y1    X1 = QLX3(KK)    Y1 = QLY3(KK)    GOSUB DRAWØLINE    IF SIDES = 3 THEN BEGIN      X2 = TX      Y2 = TY      GOSUB DRAWØLINE    BEND:ELSE BEGIN  ' SIDES = 4      X2 = QLX4(KK)      Y2 = QLY4(KK)      GOSUB DRAWØLINE      X1 = TX      Y1 = TY      GOSUB DRAWØLINE    BEND    'CURSOR X1/2,Y1/2:PRINT "+";    'CURSOR X2/2,Y2/2:PRINT "+";    'GET KEY A$  NEXT K  ' CALC NEXT LINE POSITIONS  KK = QLIDX  ' OLD QLIDX  QLIDX = MOD(QLIDX + 1, 5)  IF QLCNT < 5 THEN QLCNT = QLCNT + 1  SQANG = SQANG + .1  IF SQANG > 2*–… THEN SQANG = SQANG - 2*–…  QLCURCLR = MOD(QLCURCLR + 1, 16)  QLCLR(QLIDX) = QLCURCLR  T = T + .1  IF T > 2*–… THEN T = T - 2*–…  GOTO TRIØLOOP  RETURN'---------------.DRAWØMANYØCUBES'---------------  CBØINCB = 0  CBØINCA = 0  T1 = 0  T2 = 0  PDIST = 45.MCØLOOP  CENTREX = 80 + 45*SIN(T2)  CENTREY = 50 + 15*SIN(T1)  PDIST = 20 - 20 * COS(T1)  CBØINCB = –…/2 * SIN(T1)  CBØINCA = –…/2 * SIN(T2)  T1 = T1 + .1  T2 = T2 + .05  IF T1 > 2*–… THEN T1=T1-2*–…  IF T2 > 2*–… THEN T2=T2-2*–…    PRINT"ì"    GOSUB DRAWØCUBE  GOTO MCØLOOP  RETURN  '---------.DRAWØCUBE'---------  CBIDX = 0  CBØANGB = ATN(1/SQR(2))  FOR CBØANGA = –… / 4 TO 1.9 * –… STEP –…/2    CBTMP = PDIST * COS(CBØANGB)    PZ = CBTMP * SIN(CBØANGA)    PY(CBIDX) = PDIST * SIN(CBØANGB)    PX(CBIDX) = CBTMP * COS(CBØANGA)    GOSUB ROTATEØINCA    GOSUB ROTATEØINCB    PX(CBIDX) = CENTREX + PX(CBIDX) - PZ * ZFACT / 4    PY(CBIDX) = CENTREY + PY(CBIDX) + PZ * ZFACT    'PRINT "PX(";CBIDX;")=";PX(CBIDX);", PY(";CBIDX;")=";PY(CBIDX)    CBIDX = CBIDX + 1  NEXT CBØANGA   PLEN = 4  GOSUB DRAWØPOLY  ' DRAW LINES FROM POLY  CBIDX = 0  CBØANGB = -ATN(1/SQR(2))  FOR CBØANGA = –… / 4 TO 1.9 * –… STEP –…/2    X1 = PX(CBIDX)    Y1 = PY(CBIDX)    CBTMP = PDIST * COS(CBØANGB)    PZ = CBTMP * SIN(CBØANGA)    PY(CBIDX) = PDIST * SIN(CBØANGB)    PX(CBIDX) = CBTMP * COS(CBØANGA)    GOSUB ROTATEØINCA    GOSUB ROTATEØINCB    PX(CBIDX) = CENTREX + PX(CBIDX) - PZ * ZFACT / 4    PY(CBIDX) = CENTREY + PY(CBIDX) + PZ * ZFACT    X2 = PX(CBIDX)    Y2 = PY(CBIDX)    GOSUB DRAWØLINE    CBIDX = CBIDX + 1  NEXT CBØANGA  PLEN = 4  GOSUB DRAWØPOLY  RETURN'---------.DRAWØPOLY'---------  FOR PIDX = 0 TO PLEN-2    X1 = PX(PIDX) : Y1 = PY(PIDX)    X2 = PX(PIDX+1) : Y2 = PY(PIDX+1)    ' PRINT "X1=";X1;", Y1=";Y1;", X2=";X2;", Y2=";Y2    ' GET KEY A$    GOSUB DRAWØLINE  NEXT PIDX  X1 = PX(PLEN-1) : Y1 = PY(PLEN-1)  X2 = PX(0) : Y2 = PY(0)  GOSUB DRAWØLINE  RETURN'-----------.ROTATEØINCA'-----------  ' ROTATE ALONG Y-AXIS BY INCA  DIFFX = PX(CBIDX)  DIFFY = PZ  CBTMP = SQR(DIFFX*DIFFX + DIFFY*DIFFY)  GOSUB ATAN2  ' RETURNS ANGLE  ANGLE = ANGLE + CBØINCA  PX(CBIDX) = CBTMP * COS(ANGLE)  PZ = CBTMP * SIN(ANGLE)   RETURN'-----------.ROTATEØINCB'-----------  ' ROTATE ALONG Z-AXIS BY INCB  DIFFX = PX(CBIDX)  DIFFY = PY(CBIDX)  CBTMP = SQR(DIFFX*DIFFX + DIFFY*DIFFY)  GOSUB ATAN2  ' RETURNS ANGLE  ANGLE = ANGLE + CBØINCB  PX(CBIDX) = CBTMP * COS(ANGLE)  PY(CBIDX) = CBTMP * SIN(ANGLE)   RETURN'-----.ATAN2'-----  IF DIFFX = 0 THEN BEGIN    IF DIFFY<0 THEN ANGLE = - –…/2    IF DIFFY>0 THEN ANGLE = –…/2  BEND:ELSE BEGIN    TANVAL = DIFFY / DIFFX    ANGLE = ATN(TANVAL)  ' THIS IS RANGE -90DEG TO 90DEG    IF DIFFX<0 THEN BEGIN     IF DIFFY<0 THEN ANGLE = ANGLE - –…:ELSE ANGLE = ANGLE + –…    BEND  BEND  RETURN'---------.DRAWØLINE'---------  BANK 0  SYS $7E1B  X1 = MOD(INT(X1)+256,256)  Y1 = MOD(INT(Y1)+256,256)  X2 = MOD(INT(X2)+256,256)  Y2 = MOD(INT(Y2)+256,256)  SYS $7E21, X1, Y1, X2, Y2  BANK 128  RETURN'----.INIT'----  M = 0  PRINT "INITIALISING..."  GOSUB INITØBASLOGO  GOSUB LOADØDATA  SONG$ = "ENIGMA.P"  GOSUB LOADØSONG  FOR K = 0 TO 20    STARX%(K) = INT(RND(1)*80)*256    STARY(K) = INT(RND(1)*50)    STARVX%(K) = (RND(1)*4 + .5)*256  NEXT K  ' CLEAR THE OFFSCREEN BUFFER  EDMA 3, $FA0, 32, $50000  EDMA 3, $FA0, 0, $51000  EDMA 3, $FA0, 32, $52000  EDMA 3, $FA0, 0, $53000  EDMA 3, $FA0, 32, $54000  EDMA 3, $FA0, 0, $55000  FNAME$ = "ANA.LN"  FIDX% = 0  VER(FIDX%) = 1  GOSUB LOADØLINEØFILE  FNAME$ = "SILENT.L"  FIDX% = 1  VER(FIDX%) = 2  GOSUB LOADØLINEØFILE  GOSUB INITØWRITER  GOSUB INITØMEGAPLOT  ' INIT VAR INTERFACE TO ASSEMBLY  LOC = $40036  PTR = POINTER(STARX%(0))  GOSUB STOREØPTR  PTR = POINTER(STARVX%(0))  GOSUB STOREØPTR  RETURN'---------.LOADØSONG'---------  DOPEN #2,(SONG$),R,U8  ' LOAD MELODY CHUNKS  ' ------------------  INPUT #2, CHUNKØCNT  FOR CHUNKØIDX = 0 TO CHUNKØCNT - 1    FOR VIDX=0 TO 5      INPUT #2,V$(VIDX, CHUNKØIDX)    NEXT VIDX  NEXT CHUNKØIDX  INPUT #2,TMPO%    ' LOAD ENVELOPES  ' --------------  FOR ROW = 0 TO 9    INPUT #2, TMP$    INPUT #2, TMP    INPUT #2, TMP    INPUT #2, TMP    INPUT #2, TMP    INPUT #2, TMP    INPUT #2, TMP  NEXT ROW  PRINT  ' LOAD FILTER PRESETS  ' -------------------  FOR ROW = 0 TO 10    INPUT #2, TMP$    INPUT #2, TMP    INPUT #2, TMP    INPUT #2, TMP    INPUT #2, TMP    INPUT #2, TMP    INPUT #2, TMP    INPUT #2, TMP    INPUT #2, TMP  NEXT ROW  ' LOAD SEQUENCE  ' -------------  SEQCNT = 0  INPUT #2, SEQCNT  ROW = 0  DO WHILE ROW < SEQCNT    INPUT #2, SEQØCHUNK(ROW)    INPUT #2, SEQØEXTRA(ROW)    ROW = ROW + 1  LOOP  DCLOSE #2  CHUNKØIDX = 0  RETURN'--------------------.PARSEØCURRENTØSEQPTR'--------------------  RET% = 0  IF PLYPTR = -1 THEN RET%=1:RETURN  IF RPLAY(1)<>0 THEN RET%=1:RETURN  K = SEQØCHUNK(PLYPTR)    IF K >= 0 THEN BEGIN    CHUNKØIDX = K    IF CHUNKØRPT <= 0 THEN CHUNKØRPT = SEQØEXTRA(PLYPTR)    GOSUB PLAYØCHUNKØIDX    'SLEEP .1    RET% = 1  BEND  IF K = √ÕƒØ‘≈Õ–œ THEN BEGIN    K = SEQØEXTRA(PLYPTR)    TEMPO (K)    TMPO% = K  BEND  IF K = √ÕƒØ≈√»œØÕ1 THEN ECHOØM = 1 : ECHOØDELAY = 0  IF K = √ÕƒØ≈√»œØÕ2 THEN ECHOØM = 2 : ECHOØDELAY = 0  IF K = √ÕƒØ≈√»œØ¬  THEN ECHOØB = 1 : ECHOØDELAY = 0  IF K = √ÕƒØ≈√»œØœ∆∆ THEN ECHOØM = 0 : ECHOØB = 0  IF K = √ÕƒØ≈√»œØ”⁄ THEN ECHOØSZ = SEQØEXTRA(PLYPTR)  IF K = √ÕƒØƒ≈Ã¡Ÿ THEN ECHOØDELAY = 1 : ECHOØM = 0 : ECHOØB = 0  IF K = √ÕƒØ÷œÃ THEN V = SEQØEXTRA(PLYPTR) : VOL V, V  IF CHUNKØRPT > 0 THEN CHUNKØRPT = CHUNKØRPT - 1  IF CHUNKØRPT <= 0 THEN PLYPTR = PLYPTR + 1  IF K = √ÕƒØÃœœ– THEN PLYPTR = 0  IF PLYPTR >= SEQCNT THEN PLYFLAG = 0 : PLYPTR = -1  RETURN'--------------.PLAYØCHUNKØIDX'--------------  V1$ = V$(0,CHUNKØIDX)  V2$ = V$(1,CHUNKØIDX)  V3$ = V$(2,CHUNKØIDX)  V4$ = V$(3,CHUNKØIDX)  V5$ = V$(4,CHUNKØIDX)  V6$ = V$(5,CHUNKØIDX)  IF ECHOØDELAY = 1 THEN BEGIN    PLAY V1$    SLEEP (ECHOØSZ)    PLAY ,V2$    SLEEP (ECHOØSZ)    PLAY ,,V3$    SLEEP (ECHOØSZ)    PLAY ,,,V4$    SLEEP (ECHOØSZ)    PLAY ,,,,V5$    SLEEP (ECHOØSZ)    PLAY ,,,,,V6$    SLEEP (ECHOØSZ)    RETURN  BEND  IF ECHOØM = 0 AND ECHOØB = 0 THEN BEGIN    PLAY V1$, V2$, V3$, V4$, V5$, V6$    RETURN  BEND  IF ECHOØM = 1 AND ECHOØB = 0 THEN BEGIN    PLAY V1$, V2$, V3$,    , V5$, V6$    SLEEP (ECHOØSZ)    PLAY    ,    ,    , V1$  BEND  IF ECHOØM = 1 AND ECHOØB = 1 THEN BEGIN    PLAY V1$, V2$, V3$,    , V5$    SLEEP (ECHOØSZ)    PLAY    ,    ,    , V1$,    , V3$  BEND  IF ECHOØM = 2 AND ECHOØB = 0 THEN BEGIN    PLAY V1$,    , V3$,    ,    , V6$    SLEEP (ECHOØSZ)    PLAY    ,    ,    , V1$    SLEEP (ECHOØSZ)    PLAY    , V1$    SLEEP (ECHOØSZ)    PLAY    ,    ,    ,    , V1$  BEND  IF ECHOØM = 2 AND ECHOØB = 1 THEN BEGIN    PLAY V1$,    , V3$    SLEEP (ECHOØSZ)    PLAY    ,    ,    , V1$    SLEEP (ECHOØSZ)    PLAY    , V1$,    ,    ,    , V3$    SLEEP (ECHOØSZ)    PLAY    ,    ,    ,    , V1$  BEND  RETURN'-------------.INITØMEGAPLOT'-------------  ' INIT  QLIDX = 0 : QLCNT = 0  QLX1(QLIDX) = INT(RND(1)*160)  QLY1(QLIDX) = INT(RND(1)*100)  QLX2(QLIDX) = INT(RND(1)*160)  QLY2(QLIDX) = INT(RND(1)*100)  QLCNT = QLCNT + 1  QLVX1 = RND(1)*3 + 1  QLVY1 = RND(1)*3 + 1  QLVX2 = RND(1)*3 + 1  QLVY2 = RND(1)*3 + 1  QLCURCLR = MOD(QLCURCLR + 1, 16)  QLCLR(QLIDX) = QLCURCLR  RETURN'-----------.INITØWRITER'-----------  TXTØK = 0  WXX = 0 : WYY = 0  FNAME$ = "ABC.LN"  FIDX% = 2  VER(FIDX%) = 3  GOSUB LOADØLINEØFILE  CHARØCNT = 0  CHARØIDX%(0) = 0  CHARØWIDTH%(0) = 0  MAXØWIDTH = 0  K = 0  DO WHILE K < DIDX%(FIDX%)    ' GET X VALUE    VAL& = LDATA&(FIDX%, K)    K=K+1    IF VAL& = $FF THEN BEGIN      ' KEEP AN ARRAY OF WIDTHS OF EACH LETTER      CHARØWIDTH%(CHARØCNT)=MAXØWIDTH      ' PRINT "CHARØWIDTH(";CHARØCNT;") = ";MAXØWIDTH      ' GET KEY Z$      MAXØWIDTH = 0      CHARØCNT=CHARØCNT+1      ' KEEP AN ARRAY OF INDICES TO EACH DRAWN LETTER      CHARØIDX%(CHARØCNT) = K      'PRINT "CHARØIDX%(";CHARØCNT;")=";K      'GET KEY A$    BEND    IF VAL& = $FF THEN GOTO CONTØLOOP    VAL& = VAL& AND $7F    IF VAL& > MAXØWIDTH THEN MAXØWIDTH = VAL&        K=K+1  ' SKIP Y VALUE    K=K+1  ' SKIP CHAR .CONTØLOOP  LOOP  RETURN'---------------.ITERØWRITEØTEXT'---------------  IF WCØFLAG = 0 AND TXTØK > 0 AND TXTØK <= LEN(S$) THEN BEGIN    CHR = ASC(MID$(S$, TXTØK, 1))    ' PRINT "";CHR$(27);"QCHR=";CHR;    GOSUB PETSCIIØTOØSCREENCODE    GOSUB SCREENCODEØTOØIDX    ' PRINT "FIXED CHR=";CHR;    ' GET KEY Z$    IF CHR=32 THEN BEGIN      WXX=WXX+7      TXTØK = TXTØK + 1    BEND:ELSE:BEGIN      WCØFLAG = 1      WCØCHR = CHR      PIDX%(FIDX%) = CHARØIDX%(CHR)    BEND  BEND  IF WCØFLAG = 1 THEN BEGIN    CHR = WCØCHR    GOSUB ITERØWRITEØCHAR    IF RET = 1 THEN BEGIN      WXX = WXX + CHARØWIDTH%(WCØCHR) + 1      TXTØK = TXTØK + 1      WCØFLAG = 0    BEND  BEND  RETURN'----------.ITERØWRITEØCHAR'---------------  ' ITERATE OVER CHARS IN STRING    ' DRAW CURRENT CHAR AT GIVEN X,Y POS    ' INCREMENT X,Y LOCATION  RET = 1  IF PIDX%(FIDX%) < DIDX%(FIDX%) AND LDATA&(FIDX%, PIDX%(FIDX%)) <> $FF THEN BEGIN    ' CURSOR 0,49    ' PRINT CHR$(27);"QPIDX=";PIDX%(FIDX%);"[";LDATA&(FIDX%, PIDX%);    ' PRINT LDATA&(FIDX%, PIDX%+1);LDATA&(FIDX%, PIDX%+2);    VAL& = LDATA&(FIDX%, PIDX%(FIDX%))    PIDX%(FIDX%) = PIDX%(FIDX%) + 1    X = VAL& AND $7F    IF VAL& AND $80 THEN REVØFLAG&(FIDX%) = 1 : ELSE REVØFLAG&(FIDX%) = 0    Y = LDATA&(FIDX%, PIDX%(FIDX%))    PIDX%(FIDX%) = PIDX%(FIDX%) + 1    A$ = CHR$(LDATA&(FIDX%, PIDX%(FIDX%)))    PIDX%(FIDX%) = PIDX%(FIDX%) + 1    DXX = WXX+X : DYY = WYY+Y : GOSUB DRAWØCHAR    ' PRINT "";CHR$(27);"Q X,Y,PIDX,A$=";X;Y;PIDX%(FIDX%),ASC(A$)    ' GET KEY A$    RET = 0.PDØENDLOOP  BEND  RETURN'---------.STOREØPTR'---------  WPOKE LOC, PTR  LOC = LOC + 2  RETURN'--------------.LOADØLINEØFILE'-------------- ' (FNAME$)  IF FNAME$ = "" THEN RETURN  GOSUB LINEØFILEØINIT  DOPEN #2,(FNAME$),R,U8  DO    GET #2, VAL&    IF ST THEN EXIT    LDATA&(FIDX%, DIDX%(FIDX%)) = VAL&    DIDX%(FIDX%) = DIDX%(FIDX%) + 1  LOOP  DCLOSE #2  GOSUB PLAYØDATAØINIT  RETURN'--------------.LINEØFILEØINIT'--------------  OLDX = -1 : OLDY = -1 : OLDOFFS(FIDX%) = 0  DIDX%(FIDX%) = 0  GROUPØFLAG& = 0 : REVØFLAG&(FIDX%) = 0  OFFS(FIDX%) = 0  RETURN'--------------.DRAWØSTARFIELD'--------------  FOR K = 0 TO 20    POKE $50000 + STARX%(K)/256 + STARY(K) * 80, 46  ' DOT  NEXT K  RETURN'--------------.ITERØSTARFIELD'--------------  BANK 0:SYS $7E0F:BANK 128  'FOR K = 0 TO 20  '  STARX(K) = MOD( (STARX(K)-STARVX(K)) + 80, 80)  'NEXT K  'CURSOR 0,0  'FOR K = 0 TO 20  '  PRINT INT(STARX%(K)/256), STARY(K)  'NEXT K  'GET KEY A$  RETURN'---------.PAGEØFLIP'---------  BANK 0 : SYS $7E15 : BANK 128  RETURN'--------------.PLAYØDATAØINIT'--------------  OFFS(FIDX%)=0  PIDX%(FIDX%) = 0  IF LASTFLAG = 1 THEN PIDX%(FIDX%) = LASTØGROUPØIDX : LASTFLAG = 0  RETURN'--------------.PLAYØDATAØITER'--------------  IF PIDX%(FIDX%) < DIDX%(FIDX%) THEN BEGIN    VAL& = LDATA&(FIDX%, PIDX%(FIDX%))    PIDX%(FIDX%) = PIDX%(FIDX%) + 1    IF VER(FIDX%)=3 AND VAL& = $FF THEN BEGIN      IF PIDX%(FIDX%) > LASTØGROUPØIDX THEN LASTØGROUPØIDX = PIDX%(FIDX%)      GOTO PDØENDLOOP    BEND    X = VAL& AND $7F    IF VER(FIDX%)=2 THEN BEGIN      X = VAL&      VAL& = LDATA&(FIDX%, PIDX%(FIDX%))      PIDX%(FIDX%) = PIDX%(FIDX%) + 1      X = X + (VAL& AND $7F) * 256    BEND    IF VAL& AND $80 THEN REVØFLAG&(FIDX%) = 1: ELSE REVØFLAG&(FIDX%) = 0    Y = LDATA&(FIDX%, PIDX%(FIDX%))    PIDX%(FIDX%) = PIDX%(FIDX%) + 1    A$ = CHR$(LDATA&(FIDX%, PIDX%(FIDX%)))    PIDX%(FIDX%) = PIDX%(FIDX%) + 1    IF VER(FIDX%)=2 THEN BEGIN      IF X-OFFS(FIDX%) > 78 THEN BEGIN        GOSUB SCROLLØCANVASØRIGHT        PIDX%(FIDX%) = PIDX%(FIDX%) - 4        RETURN        ' PRINT "";CHR$(27);"QOFFS=";OFFS(FIDX%);      BEND    BEND    DXX = X-OFFS(FIDX%) : DYY = Y: GOSUB DRAWØCHAR    DEBUG = 0    IF DEBUG=1 THEN BEGIN      PRINT "";CHR$(27);"Q X,Y,PIDX,A$,OFFS=";X;Y;PIDX%(FIDX%),ASC(A$),OFFS(FIDX%)      GET KEY A$    BEND.PDØENDLOOP  BEND  X = X-OFFS(FIDX%)  RETURN'---------.DRAWØCHAR'---------  ' POKE $40800 + X + Y*80, ASC(A$)  ' POKE $FF80000 + X + Y*80, RCOLOR(1)    CHR = ASC(A$)  GOSUB PETSCIIØTOØSCREENCODE  IF REVØFLAG&(FIDX%) = 1 THEN CHR = CHR + 128  IF VER(FIDX%) = 1 THEN BEGIN    POKE $52000 + DXX + DYY*80, CHR    POKE $53000 + DXX + DYY*80, 1  BEND  IF VER(FIDX%) = 2 OR VER(FIDX%) = 3 THEN BEGIN    POKE $54000 + DXX + DYY*80, CHR    POKE $55000 + DXX + DYY*80, 2  BEND  RETURN'---------------------.PETSCIIØTOØSCREENCODE'---------------------  ' ¬ASED ON THE TABLE HERE:  ' HTTPS://STA.C64.ORG/CBM64PETTOSCR.HTML  ' - SEEMS LIKE … NEEDED TO DO A REPAIR TO IT ON THE $A0-->$BF RANGE  IF CHR>=$00 AND CHR<=$1F THEN CHR=CHR OR $80:RETURN  IF CHR>=$20 AND CHR<=$3F THEN RETURN  IF CHR>=$40 AND CHR<=$5F THEN CHR=CHR AND $BF:RETURN  IF CHR>=$60 AND CHR<=$7F THEN CHR=CHR AND $DF:RETURN  IF CHR>=$80 AND CHR<=$9F THEN CHR=CHR OR $40:RETURN  IF CHR>=$A0 AND CHR<=$BF THEN CHR=(CHR AND $7F) OR $40:RETURN ' $BF:RETURN  IF CHR>=$C0 AND CHR<=$FE THEN CHR=CHR AND $7F:RETURN  RETURN'-----------------.SCREENCODEØTOØIDX'-----------------  IF CHR >= 65 AND CHR <= 90 THEN CHR = CHR - 65:RETURN  IF CHR = 46 THEN CHR = 26:RETURN ' FULL-STOP  IF CHR = 33 THEN CHR = 27:RETURN ' EXCLAMATION  IF CHR = 44 THEN CHR = 28:RETURN ' COMMA (SMILEY)  IF CHR = 47 THEN CHR = 29:RETURN ' FORWARD SLASH (LOVE HEART)  IF CHR = 35 THEN CHR = 30:RETURN ' # HASH (DHUFISH)  IF CHR >= 1 AND CHR <= 26 THEN CHR = CHR + 30  RETURN'---------------.TRANSPARENTØDMA'---------------  WPOKE $40009, SRCØADDR  WPOKE $4000C, DESTØADDR  WPOKE $40007, LENGTH  POKE  $40004, TRANSP  POKE $D702, 4 ' DMA LIST IN BANK 4  POKE $D701, $00 ' DMA LIST MSB  POKE $D705, $00 ' DMA LIST LSB  RETURN'------------------.SCROLLØCANVASØLEFT'------------------  FOR YY = 0 TO 49    EDMA œ–Ø√œ–Ÿ+ƒ”‘Øƒ≈√+”“√Øƒ≈√, _           79, $52000 + YY*80 + 78, $52000 + YY*80 + 79    POKE $52000 + YY*80, 32   NEXT YY  RETURN'-------------------.SCROLLØCANVASØRIGHT'-------------------  OFFS(FIDX%) = OFFS(FIDX%) + 1  IF FIDX% = 0 THEN ADDR = $20  ' $52000  IF FIDX% = 1 THEN ADDR = $40  ' $54000  BANK 0:SYS $7E12, ADDR: BANK 128  RETURN